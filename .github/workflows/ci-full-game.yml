name: CI Full Game Test

on:
  pull_request:
  workflow_dispatch:

jobs:
  full-game:
    runs-on: ubuntu-latest
    env:
      BASE_URL: http://localhost:3000
      REAL_JWT_SECRET: ${{ secrets.REAL_JWT_SECRET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Runner debug
        shell: bash
        run: |
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          docker --version || true
          docker compose version || true
          echo "Repo root listing:"
          ls -la

      - name: Install Docker Compose plugin
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y curl
          DOCKER_CONFIG=${DOCKER_CONFIG:-$HOME/.docker}
          mkdir -p $DOCKER_CONFIG/cli-plugins
          curl -SL "https://github.com/docker/compose/releases/download/v2.20.2/docker-compose-linux-x86_64" -o $DOCKER_CONFIG/cli-plugins/docker-compose
          chmod +x $DOCKER_CONFIG/cli-plugins/docker-compose
          docker compose version

      - name: Ensure required secrets exist
        shell: bash
        env:
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          REAL_JWT_SECRET: ${{ secrets.REAL_JWT_SECRET }}
        run: |
          missing=0
          for s in GOOGLE_CLIENT_ID GOOGLE_CLIENT_SECRET SESSION_SECRET REAL_JWT_SECRET; do
            if [ -z "${!s}" ]; then
              echo "Missing secret: $s"
              missing=1
            fi
          done
          if [ "$missing" -eq 1 ]; then
            echo "One or more required secrets are missing. Aborting."
            exit 1
          fi

      - name: Create CI env file from secrets
        shell: bash
        env:
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          REAL_JWT_SECRET: ${{ secrets.REAL_JWT_SECRET }}
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
        run: |
          printf '%s\n' \
            "GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID" \
            "GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET" \
            "SESSION_SECRET=$SESSION_SECRET" \
            "JWT_SECRET=$REAL_JWT_SECRET" \
            "BASE_URL=http://localhost:3000" \
            "NGROK_AUTHTOKEN=$NGROK_AUTHTOKEN" \
          > .env.ci
          chmod 600 .env.ci
          echo ".env.ci created"

      - name: Debug .env.ci (presence only)
        shell: bash
        run: |
          echo "---- .env.ci keys (no secret values printed) ----"
          for k in GOOGLE_CLIENT_ID GOOGLE_CLIENT_SECRET SESSION_SECRET JWT_SECRET NGROK_AUTHTOKEN; do
            if grep -qE "^${k}=" .env.ci; then echo "$k=LINE_PRESENT"; else echo "$k=MISSING_LINE"; fi
          done
          tr -d '\r' < .env.ci > .env.ci.tmp && mv .env.ci.tmp .env.ci || true

      - name: Show compose file if present
        shell: bash
        run: |
          if [ -f ./compose.yaml ]; then
            echo "Found compose.yaml"
            sed -n '1,200p' ./compose.yaml
          else
            echo "ERROR: compose.yaml not found at repo root"
            ls -la
            exit 1
          fi

      - name: Start stack
        shell: bash
        run: docker compose --env-file .env.ci -f ./compose.yaml up -d --build

            - name: Wait for DB and backend health
        shell: bash
        run: |
          set -euo pipefail

          # Wait for DB container to report healthy via Docker healthcheck
          echo "Waiting for db container to become healthy..."
          DB_CONTAINER=$(docker compose -f ./compose.yaml ps -q db)
          if [ -z "$DB_CONTAINER" ]; then
            echo "DB container not found; listing containers:" && docker compose -f ./compose.yaml ps
            exit 1
          fi

          for i in {1..60}; do
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' "$DB_CONTAINER" 2>/dev/null || echo "no-health")
            echo "db health status: $STATUS (attempt $i/60)"
            if [ "$STATUS" = "healthy" ]; then
              echo "db healthy"
              break
            fi
            sleep 2
          done

          if [ "$STATUS" != "healthy" ]; then
            echo "DB did not become healthy in time" && docker compose -f ./compose.yaml logs db --no-color --tail 200 || true
            exit 1
          fi

          # Now wait for backend /health to respond
          echo "Waiting for backend /health..."
          for i in {1..120}; do
            if curl -sSf http://localhost:3000/health >/dev/null 2>&1; then
              echo "backend healthy"
              exit 0
            fi
            echo "waiting for backend... ($i)"
            docker compose -f ./compose.yaml logs backend --no-color --tail 20 || true
            sleep 1
          done

          echo "backend did not become healthy" && docker compose -f ./compose.yaml logs backend --no-color --tail 200 || true && exit 1


      - name: Check JWT_SECRET inside backend container
        shell: bash
        run: |
          docker compose --env-file .env.ci -f ./compose.yaml exec -T backend bash -lc '
            if [ -z "${JWT_SECRET}" ]; then echo "JWT_SECRET=EMPTY"; else echo "JWT_SECRET=SET"; fi
          '

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install test dependencies
        shell: bash
        run: |
          if [ -f package.json ]; then npm ci; fi

      - name: Run full game test (generate token file)
        shell: pwsh
        env:
          BASE_URL: ${{ env.BASE_URL }}
          REAL_JWT_SECRET: ${{ env.REAL_JWT_SECRET }}
        run: |
          if (-not $env:REAL_JWT_SECRET) { Write-Error "REAL_JWT_SECRET not set"; exit 1 }
          $playerA = node -e "const jwt=require('jsonwebtoken'); console.log(jwt.sign({ sub:'ci-player-a', email:'ci_a@example.com', provider:'ci' }, process.env.REAL_JWT_SECRET, { algorithm:'HS256', expiresIn:'7d' }));"
          $playerB = node -e "const jwt=require('jsonwebtoken'); console.log(jwt.sign({ sub:'ci-player-b', email:'ci_b@example.com', provider:'ci' }, process.env.REAL_JWT_SECRET, { algorithm:'HS256', expiresIn:'7d' }));"
          Set-Content -Path token.txt -Value $playerA -NoNewline
          $env:PLAYER_A = $playerA
          $env:PLAYER_B = $playerB
          try {
            Invoke-RestMethod -Uri "$env:BASE_URL/api/auth/me" -Headers @{ Authorization = "Bearer $env:PLAYER_A" } -Method Get -TimeoutSec 10 | Out-Null
          } catch {
            Write-Error "Preflight auth/me failed for PLAYER_A"
            exit 1
          }
          pwsh ./tests/Test-FullGame.ps1

      - name: Verify test token inside backend container
        shell: bash
        run: |
          if [ ! -f token.txt ]; then echo "token.txt missing"; exit 1; fi
          TOKEN=$(cat token.txt)
          docker compose --env-file .env.ci -f ./compose.yaml exec -T backend bash -lc "
            node -e \"
              const jwt = require('jsonwebtoken');
              const token = process.argv[1];
              try { jwt.verify(token, process.env.JWT_SECRET); console.log('VERIFY_OK'); process.exit(0); }
              catch (err) { console.error('VERIFY_FAIL:', err.message); process.exit(2); }
            \" '$TOKEN'
          "

      - name: Collect docker logs on failure
        if: failure()
        shell: bash
        run: |
          echo "=== docker compose ps ==="
          docker compose -f ./compose.yaml ps || true
          echo "=== backend logs ==="
          docker compose -f ./compose.yaml logs backend --no-color --tail 500 || true
          echo "=== container list ==="
          docker ps -a || true

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ci-full-game-logs
          path: |
            tests/logs/**
            compose.yaml
            token.txt

      - name: Tear down stack
        if: always()
        shell: bash
        run: |
          docker compose --env-file .env.ci -f ./compose.yaml down -v || true
          rm -f .env.ci token.txt || true
