name: CI Full Game Test

on:
  pull_request:
  workflow_dispatch:

jobs:
  full-game:
    runs-on: ubuntu-latest
    env:
      BASE_URL: http://localhost:3000
      REAL_JWT_SECRET: ${{ secrets.REAL_JWT_SECRET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Runner debug
        run: |
          echo "GITHUB_REF=$GITHUB_REF"
          echo "GITHUB_SHA=$GITHUB_SHA"
          docker --version || true
          docker compose version || true
          which docker-compose || true

      # start the stack using the explicit repo-root compose file
      - name: Start backend (explicit compose file)
        run: |
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          echo "Checking for compose file at $GITHUB_WORKSPACE/compose.yaml"
          if [ -f "$GITHUB_WORKSPACE/compose.yaml" ]; then
            echo "Found compose file"
            sed -n '1,200p' "$GITHUB_WORKSPACE/compose.yaml"
            docker compose -f "$GITHUB_WORKSPACE/compose.yaml" up -d --build
          else
            echo "ERROR: compose file not found at $GITHUB_WORKSPACE/compose.yaml"
            ls -la "$GITHUB_WORKSPACE"
            exit 14
          fi

      # wait for health
      - name: Wait for backend health
        run: |
          for i in {1..120}; do
            if curl -sSf http://localhost:3000/health >/dev/null 2>&1; then
              echo "backend healthy"
              exit 0
            fi
            echo "waiting for backend... ($i)"
            sleep 1
          done
          echo "backend did not become healthy" && exit 1

      # collect logs using the same explicit file
      - name: Collect docker logs on failure
        if: failure()
        run: |
          echo "=== docker compose ps ==="
          docker compose -f "$GITHUB_WORKSPACE/compose.yaml" ps || true
          echo "=== backend logs ==="
          docker compose -f "$GITHUB_WORKSPACE/compose.yaml" logs backend --no-color --tail 500 || true


      - name: Show compose config
        run: docker compose config || true

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install test dependencies
        run: |
          if [ -f package.json ]; then
            npm ci
          fi

      - name: Run full game test
        shell: pwsh
        run: |
          if (-not $env:REAL_JWT_SECRET) { Write-Error "REAL_JWT_SECRET not set"; exit 1 }
          $env:PLAYER_A = node -e "const jwt=require('jsonwebtoken'); console.log(jwt.sign({ sub:'ci-player-a', email:'ci_a@example.com', provider:'ci' }, process.env.REAL_JWT_SECRET, { algorithm:'HS256', expiresIn:'7d' }));"
          $env:PLAYER_B = node -e "const jwt=require('jsonwebtoken'); console.log(jwt.sign({ sub:'ci-player-b', email:'ci_b@example.com', provider:'ci' }, process.env.REAL_JWT_SECRET, { algorithm:'HS256', expiresIn:'7d' }));"
          # optional preflight auth check
          try {
            Invoke-RestMethod -Uri "$env:BASE_URL/api/auth/me" -Headers @{ Authorization = "Bearer $env:PLAYER_A" } -Method Get -TimeoutSec 10 | Out-Null
          } catch {
            Write-Error "Preflight auth/me failed for PLAYER_A"
            exit 1
          }
          pwsh ./tests/Test-FullGame.ps1

      - name: Collect docker logs on failure
        if: failure()
        run: |
          echo "=== docker compose ps ==="
          docker compose ps || true
          echo "=== backend logs ==="
          docker compose logs backend --no-color --tail 500 || true

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ci-full-game-logs
          path: |
            tests/logs/**
            docker-compose.yml
