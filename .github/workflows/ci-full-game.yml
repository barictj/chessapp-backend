name: CI Full Game

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  ci-full-game:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    env:
      WORKFLOW_BACKEND_POLL_RETRIES: 240
      WORKFLOW_BACKEND_POLL_SLEEP: 2

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Runner info
        shell: bash
        run: |
          echo "=== Runner info ==="
          uname -a
          pwd
          ls -la

      # ----------------------------------------------------
      # CREATE .env.ci (MATCHES docker-compose + app)
      # ----------------------------------------------------
      - name: Create CI env file (.env.ci)
        shell: bash
        run: |
          set -euo pipefail

          BASE_URL="${{ secrets.CI_BASE_URL }}"
          JWT_SECRET="${{ secrets.REAL_JWT_SECRET }}"
          GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}"

          cat > .env.ci <<EOF
JWT_SECRET=${JWT_SECRET}
BASE_URL=${BASE_URL=http://localhost:3000}
GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
DB_HOST=db
DB_PORT=3306
DB_USER=chess
DB_PASSWORD=chesspass
DB_NAME=chess
EOF

          chmod 600 .env.ci
          echo ".env.ci created"
          grep '^BASE_URL=' .env.ci



      # ----------------------------------------------------
      # VALIDATE COMPOSE CONFIG
      # ----------------------------------------------------
      - name: Show resolved docker compose config
        shell: bash
        run: |
          docker compose --env-file .env.ci -f compose.yaml config

      # ----------------------------------------------------
      # BUILD + START STACK
      # ----------------------------------------------------
      - name: Build backend image and start stack
        shell: bash
        run: |
          set -e
          docker compose --env-file .env.ci -f compose.yaml build --no-cache backend
          docker compose --env-file .env.ci -f compose.yaml up -d --force-recreate

      # ----------------------------------------------------
      # SHOW RUNNING CONTAINERS
      # ----------------------------------------------------
      - name: Show compose ps
        shell: bash
        run: |
          docker compose --env-file .env.ci -f compose.yaml ps
          docker ps

      # ----------------------------------------------------
      # WAIT FOR DB → BACKEND HEALTH
      # ----------------------------------------------------
      - name: Wait for DB then backend health
        shell: bash
        run: |
          set -euo pipefail

          DB_CONTAINER=$(docker compose --env-file .env.ci -f compose.yaml ps -q db)
          echo "Waiting for DB health..."

          for i in $(seq 1 60); do
            STATUS=$(docker inspect --format '{{.State.Health.Status}}' "$DB_CONTAINER")
            echo "DB health: $STATUS"
            [ "$STATUS" = "healthy" ] && break
            sleep 2
          done

          echo "Waiting for backend /health..."

          for i in $(seq 1 ${WORKFLOW_BACKEND_POLL_RETRIES}); do
            HTTP_STATUS=$(curl -s -o /tmp/health.json -w "%{http_code}" http://localhost:3000/health || true)
            echo "Attempt $i → HTTP $HTTP_STATUS"

            if [ "$HTTP_STATUS" = "200" ]; then
              cat /tmp/health.json
              exit 0
            fi

            docker compose --env-file .env.ci -f compose.yaml logs backend --tail 20
            sleep ${WORKFLOW_BACKEND_POLL_SLEEP}
          done

          echo "Backend failed health check"
          exit 1

      # ----------------------------------------------------
      # GENERATE JWT INSIDE CONTAINER
      # ----------------------------------------------------
      - name: Generate JWT inside backend container
        id: gen_token
        shell: bash
        run: |
          set -euo pipefail

          TOKEN=$(docker compose --env-file .env.ci -f compose.yaml exec -T backend sh -lc \
            'node -e "const jwt=require(\"jsonwebtoken\"); console.log(jwt.sign({sub:\"ci-user\"}, process.env.JWT_SECRET,{expiresIn:\"1h\"}))"')

          echo "AUTH_TOKEN=${TOKEN}" >> $GITHUB_OUTPUT

      # ----------------------------------------------------
      # CALL PROTECTED ENDPOINT
      # ----------------------------------------------------
      - name: Call protected endpoint
        shell: bash
        run: |
          set -euo pipefail

          TOKEN="${{ steps.gen_token.outputs.AUTH_TOKEN }}"
          HTTP_STATUS=$(curl -s -o /tmp/protected.json -w "%{http_code}" \
            -H "Authorization: Bearer $TOKEN" \
            http://localhost:3000/api/secure)

          cat /tmp/protected.json
          [ "$HTTP_STATUS" = "200" ]

      # ----------------------------------------------------
      # UPLOAD LOGS ON FAILURE
      # ----------------------------------------------------
      - name: Dump logs (on failure)
        if: failure()
        shell: bash
        run: |
          docker compose --env-file .env.ci -f compose.yaml logs backend > backend.log || true
          docker compose --env-file .env.ci -f compose.yaml logs db > db.log || true

      - name: Upload logs artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs
          path: |
            backend.log
            db.log

      # ----------------------------------------------------
      # CLEANUP
      # ----------------------------------------------------
      - name: Tear down stack
        if: always()
        shell: bash
        run: |
          docker compose --env-file .env.ci -f compose.yaml down -v || true
          rm -f .env.ci
