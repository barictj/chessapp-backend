name: CI Full Game Test

on:
  pull_request:
  workflow_dispatch:

jobs:
  full-game:
    runs-on: ubuntu-latest
    env:
      BASE_URL: http://localhost:3000
      REAL_JWT_SECRET: ${{ secrets.REAL_JWT_SECRET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Runner debug
        run: |
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          docker --version || true
          docker compose version || true
          which docker-compose || true
          echo "Repo root listing:"
          ls -la

      - name: Install Docker Compose plugin
        run: |
          sudo apt-get update
          sudo apt-get install -y curl
          DOCKER_CONFIG=${DOCKER_CONFIG:-$HOME/.docker}
          mkdir -p $DOCKER_CONFIG/cli-plugins
          curl -SL "https://github.com/docker/compose/releases/download/v2.20.2/docker-compose-linux-x86_64" -o $DOCKER_CONFIG/cli-plugins/docker-compose
          chmod +x $DOCKER_CONFIG/cli-plugins/docker-compose
          docker compose version

      - name: Ensure required secrets exist
        run: |
          missing=0
          for s in GOOGLE_CLIENT_ID GOOGLE_CLIENT_SECRET SESSION_SECRET REAL_JWT_SECRET; do
            if [ -z "${{ secrets[$s] }}" ]; then
              echo "Missing secret: $s"
              missing=1
            fi
          done
          if [ "$missing" -eq 1 ]; then
            echo "One or more required secrets are missing. Aborting."
            exit 1
          fi

      - name: Create CI env file from secrets
        run: |
          cat > .env.ci <<EOF
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          SESSION_SECRET=${{ secrets.SESSION_SECRET }}
          JWT_SECRET=${{ secrets.REAL_JWT_SECRET }}
          BASE_URL=http://localhost:3000
          EOF
          chmod 600 .env.ci
          echo ".env.ci created"

      - name: Show compose file if present
        run: |
          echo "Checking for compose.yaml at repo root"
          if [ -f ./compose.yaml ]; then
            echo "Found compose.yaml"
            sed -n '1,200p' ./compose.yaml
          else
            echo "ERROR: compose.yaml not found at repo root"
            ls -la
            exit 1
          fi

      - name: Start stack
        run: docker compose --env-file .env.ci -f ./compose.yaml up -d --build

      - name: Wait for backend health
        run: |
          for i in {1..120}; do
            if curl -sSf http://localhost:3000/health >/dev/null 2>&1; then
              echo "backend healthy"
              exit 0
            fi
            echo "waiting for backend... ($i)"
            sleep 1
          done
          echo "backend did not become healthy" && exit 1

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install test dependencies
        run: |
          if [ -f package.json ]; then
            npm ci
          fi

      - name: Run full game test
        shell: pwsh
        run: |
          if (-not $env:REAL_JWT_SECRET) { Write-Error "REAL_JWT_SECRET not set"; exit 1 }
          $env:PLAYER_A = node -e "const jwt=require('jsonwebtoken'); console.log(jwt.sign({ sub:'ci-player-a', email:'ci_a@example.com', provider:'ci' }, process.env.REAL_JWT_SECRET, { algorithm:'HS256', expiresIn:'7d' }));"
          $env:PLAYER_B = node -e "const jwt=require('jsonwebtoken'); console.log(jwt.sign({ sub:'ci-player-b', email:'ci_b@example.com', provider:'ci' }, process.env.REAL_JWT_SECRET, { algorithm:'HS256', expiresIn:'7d' }));"
          try {
            Invoke-RestMethod -Uri "$env:BASE_URL/api/auth/me" -Headers @{ Authorization = "Bearer $env:PLAYER_A" } -Method Get -TimeoutSec 10 | Out-Null
          } catch {
            Write-Error "Preflight auth/me failed for PLAYER_A"
            exit 1
          }
          pwsh ./tests/Test-FullGame.ps1

      - name: Collect docker logs on failure
        if: failure()
        run: |
          echo "=== docker compose ps ==="
          docker compose -f ./compose.yaml ps || true
          echo "=== backend logs ==="
          docker compose -f ./compose.yaml logs backend --no-color --tail 500 || true
          echo "=== container list ==="
          docker ps -a || true

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ci-full-game-logs
          path: |
            tests/logs/**
            compose.yaml

      - name: Tear down stack
        if: always()
        run: |
          docker compose --env-file .env.ci -f ./compose.yaml down -v || true
          rm -f .env.ci || true
